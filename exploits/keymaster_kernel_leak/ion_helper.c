#include <linux/ioctl.h>
#include <sys/mman.h>
#include <stdio.h>
#include <stdlib.h>
#include <stddef.h>
#include <unistd.h>
#include <dirent.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include "common.h"

int32_t qcom_km_ION_memalloc(struct qcom_km_ion_info_t *handle, uint32_t size)
{
    int32_t ret = 0;
    int32_t iret = 0;
    int32_t fd = 0;
    unsigned char *v_addr;
    struct ion_allocation_data ion_alloc_data;
    int32_t ion_fd;
    int32_t rc;
    struct ion_fd_data ifd_data;
    struct ion_handle_data handle_data;
    
    ion_fd  = open("/dev/ion", O_RDONLY | 0x0010);
    if (ion_fd < 0) {
       printf("%s Error:Cannot open ION device", __func__);
       return -1;
    }
    handle->ion_sbuffer = NULL;
    handle->ifd_data_fd = 0;
    /* Size of allocation */
    ion_alloc_data.len = (size + 4095) & (~4095);
    /* 4K aligned */
    ion_alloc_data.align = 4096;
    /* memory is allocated from EBI heap */
   ion_alloc_data.heap_mask = (1 << 27);
    /* Set the memory to be uncached */
    ion_alloc_data.flags = 0;
    /* IOCTL call to ION for memory request */
    rc = ioctl(ion_fd, 0xC0144900, &ion_alloc_data);
    if (rc) {
       ret = -1;
       goto alloc_fail;
    }
    if (ion_alloc_data.handle != NULL) {
       ifd_data.handle = ion_alloc_data.handle;
    } else {
       ret = -1;
       goto alloc_fail;
    }
    /* Call MAP ioctl to retrieve the ifd_data.fd file descriptor */
    rc = ioctl(ion_fd, 0xC0084902, &ifd_data);
    if (rc) {
       ret = -1;
       goto ioctl_fail;
    }
    /* Make the ion mmap call */
    v_addr = (unsigned char *)mmap(NULL, ion_alloc_data.len,
                                    PROT_READ | PROT_WRITE,
                                    MAP_SHARED, ifd_data.fd, 0);
    if (v_addr == MAP_FAILED) {
       printf("%s Error:ION MMAP failed\n", __func__);
       ret = -1;
       goto map_fail;
    }
    handle->ion_fd = ion_fd;
    handle->ifd_data_fd = ifd_data.fd;
    handle->ion_sbuffer = v_addr;
    handle->ion_alloc_handle.handle = ion_alloc_data.handle;
    handle->sbuf_len = size;
    return ret;
map_fail:
    if (handle->ion_sbuffer != NULL) {
        iret = munmap(handle->ion_sbuffer, ion_alloc_data.len);
        if (iret)
           printf("%s Error:Failed to unmap memory for load image. ret = %d", __func__, ret);
    }
ioctl_fail:
    handle_data.handle = ion_alloc_data.handle;
    if (handle->ifd_data_fd)
        close(handle->ifd_data_fd);
    iret = ioctl(ion_fd, 0xC0044901, &handle_data);
    if (iret) {
       printf("%s Error:ION FREE ioctl returned error = %d",__func__, iret);
    }
alloc_fail:
    if (ion_fd > 0)
       close(ion_fd);
    return ret;
}
